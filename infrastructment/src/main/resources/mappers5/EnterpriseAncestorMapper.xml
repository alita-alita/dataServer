<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.idicc.taotie.infrastructment.mapper.xiaoai.EnterpriseAncestorMapper">
    <insert id="insertBatch"
            parameterType="cn.idicc.taotie.infrastructment.entity.xiaoai.EnterpriseAncestorDO">
        insert into
            enterprise_ancestor(uni_code, ancestor_code, related_type, related_member,related_member_occupation, enterprise_code, enterprise_province, enterprise_city, enterprise_area, enterprise_chain_ids)
        values
        <foreach collection="dos" separator="," open="" close="" item="do">
            (#{do.uniCode},#{do.ancestorCode},#{do.relatedType},#{do.relatedMember},#{do.relatedMemberOccupation},#{do.enterpriseCode},#{do.enterpriseProvince},#{do.enterpriseCity},#{do.enterpriseArea},#{do.enterpriseChainIds})
        </foreach>
    </insert>

    <delete id="physicsDeleteAll">
        delete from enterprise_ancestor
    </delete>
    <delete id="physicsDeleteById" parameterType="java.lang.Long">
        delete from enterprise_ancestor
        where id = #{id}
    </delete>
    <delete id="physicsDeleteByIds" parameterType="java.lang.Long">
        delete from enterprise_ancestor
        where id in
        <foreach collection="ids" separator="," open="(" close=")" item="id">
            #{id}
        </foreach>
    </delete>
    <select id="countByCodeAndChainId" resultType="java.lang.Integer">
        select count(distinct(ea.uni_code))
        from enterprise_ancestor ea
        where ea.ancestor_code like concat(#{code},'%')
        <if test="chain_id != null and chain_id != ''">
            and ea.enterprise_chain_ids like concat('%',#{chain_id},'%')
        </if>
    </select>
    <select id="countByAll" resultType="java.lang.Integer">
        select count(distinct(ea.uni_code))
        from enterprise_ancestor ea
        where ea.ancestor_code like concat(#{code},'%')
        <if test="province != null and province != ''">
            and not (ea.enterprise_province =  #{province}
            <if test="city != null and city != ''">
                and ea.enterprise_city =  #{city}
            </if>
            <if test="area != null and area != ''">
                and ea.enterprise_area =  #{area}
            </if>)
        </if>
        <if test="eProvince != null and eProvince != ''">
            and ea.enterprise_province = #{eProvince}
        </if>
        <if test="eCity != null and eCity != ''">
            and ea.enterprise_city = #{eCity}
        </if>
        <if test="eArea != null and eArea != ''">
            and ea.enterprise_area = #{eArea}
        </if>
        <if test="chain_id != null and chain_id != ''">
            and ea.enterprise_chain_ids like concat('%',#{chain_id},'%')
        </if>
    </select>
    <select id="pageByAll" resultType="cn.idicc.taotie.infrastructment.entity.xiaoai.EnterpriseAncestorDO">
        select ea.uni_code,
               any_value(ea.ancestor_code) as ancestor_code,
               any_value(ea.related_type) as related_type,
               any_value(ea.related_member) as related_member,
               any_value(ea.related_member_occupation) as related_member_occupation
        from enterprise_ancestor ea
        where ea.ancestor_code like concat(#{code},'%')
        <if test="province != null and province != ''">
            and not (ea.enterprise_province =  #{province}
            <if test="city != null and city != ''">
                and ea.enterprise_city =  #{city}
            </if>
            <if test="area != null and area != ''">
                and ea.enterprise_area =  #{area}
            </if>)
        </if>
        <if test="eProvince != null and eProvince != ''">
            and ea.enterprise_province = #{eProvince}
        </if>
        <if test="eCity != null and eCity != ''">
            and ea.enterprise_city = #{eCity}
        </if>
        <if test="eArea != null and eArea != ''">
            and ea.enterprise_area = #{eArea}
        </if>
        <if test="chain_id != null and chain_id != ''">
            and ea.enterprise_chain_ids like concat('%',#{chain_id},'%')
        </if>
        group by ea.uni_code,ea.related_type
        order by ea.related_type,ea.uni_code
    </select>
    <select id="selectByPage" resultType="cn.idicc.taotie.infrastructment.response.xiaoai.EnterpriseCodesDTO">
        select uni_code,group_concat(ancestor_code separator '/') as codes
        from enterprise_ancestor
        group by uni_code
    </select>
</mapper>
